<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nagins Games - Ludo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1 class="title">Nagins Games</h1>
        
        <!-- Main Menu -->
        <div class="menu" id="mainMenu">
            <button class="menu-btn" onclick="showPlayerInput('create')">Create Room</button>
            <button class="menu-btn" onclick="showPlayerInput('join')">Join Room</button>
        </div>

        <!-- Player Input -->
        <div class="player-input" id="playerInput">
            <input type="text" id="playerName" placeholder="Enter your name">
            <input type="text" id="roomId" placeholder="Enter Room ID (for joining)" style="display: none;">
            <button class="menu-btn" onclick="handleRoomAction()">Submit</button>
        </div>

        <!-- Lobby -->
        <div class="lobby" id="lobby">
            <h2>Room ID: <span id="displayRoomId"></span></h2>
            <div id="playersList"></div>
            <button class="menu-btn" id="startBtn" onclick="startGame()" style="display: none;">Start Game</button>
        </div>

        <!-- Game Board -->
        <div class="game-board" id="gameBoard">
            <div class="dice" id="dice" onclick="rollDice()">0</div>
            <div class="tokens-container" id="tokensContainer"></div>
        </div>

        <!-- Chat -->
        <div class="chat-box">
            <div class="chat-messages" id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Type message...">
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        let isHost = false;
        let myPlayerId = null;

        // UI Elements
        const playerInput = document.getElementById('playerInput');
        const mainMenu = document.getElementById('mainMenu');
        const lobby = document.getElementById('lobby');
        const gameBoard = document.getElementById('gameBoard');

        // Game Functions
        function showPlayerInput(action) {
            mainMenu.style.display = 'none';
            playerInput.style.display = 'flex';
            document.getElementById('roomId').style.display = action === 'join' ? 'block' : 'none';
        }

        function handleRoomAction() {
            const playerName = document.getElementById('playerName').value;
            const roomId = document.getElementById('roomId').value;

            if (!playerName) return alert('Please enter your name');
            
            if (roomId) {
                socket.emit('joinRoom', { roomId, playerName });
                currentRoom = roomId;
            } else {
                socket.emit('createRoom', playerName);
            }
        }

        function startGame() {
            socket.emit('startGame', currentRoom);
        }

        function rollDice() {
            socket.emit('rollDice', currentRoom);
        }

        // Socket Listeners
        socket.on('roomCreated', (roomId) => {
            currentRoom = roomId;
            document.getElementById('displayRoomId').textContent = roomId;
            playerInput.style.display = 'none';
            lobby.style.display = 'flex';
        });

        socket.on('roomUpdate', ({ players, gameState, isHost: hostStatus }) => {
            isHost = hostStatus;
            document.getElementById('startBtn').style.display = isHost && gameState === 'waiting' ? 'block' : 'none';
            document.getElementById('playersList').innerHTML = players
                .map(p => `<div style="color: ${p.color || '#fff'}">${p.name} ${p.isHost ? 'ðŸ‘‘' : ''}</div>`)
                .join('');
        });

        socket.on('gameStarted', (players) => {
            lobby.style.display = 'none';
            gameBoard.style.display = 'block';
            initializeTokens(players);
        });

        socket.on('diceRolled', (value) => {
            document.getElementById('dice').textContent = value;
        });

        socket.on('gameUpdate', (players) => {
            updateTokens(players);
        });

        socket.on('newMessage', ({ message, sender }) => {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML += `<div><strong>${sender}:</strong> ${message}</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // Chat Functionality
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.value.trim()) {
                socket.emit('chatMessage', {
                    roomId: currentRoom,
                    message: e.target.value,
                    sender: document.getElementById('playerName').value
                });
                e.target.value = '';
            }
        });

        // Game Board Functions
        function initializeTokens(players) {
            const container = document.getElementById('tokensContainer');
            players.forEach(player => {
                player.pieces.forEach((piece, index) => {
                    const token = document.createElement('div');
                    token.className = 'token';
                    token.style.backgroundColor = player.color;
                    token.id = `token-${player.id}-${index}`;
                    container.appendChild(token);
                });
            });
        }

        function updateTokens(players) {
            players.forEach(player => {
                player.pieces.forEach((piece, index) => {
                    const token = document.getElementById(`token-${player.id}-${index}`);
                    if (token) {
                        // Update position based on pathIndex
                        token.style.transform = `translate(${piece.pathIndex * 10}px, 0)`;
                    }
                });
            });
        }
    </script>
</body>
</html>
